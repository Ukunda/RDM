# Refactoring Random Clip Player

The [random_clip_player.py](file:///c:/Hobby/RDM/random_clip_player.py) file has grown to over 3,100 lines. To safely untangle this monolith and improve maintainability, we will execute a phased, incremental refactoring strategy. This avoids the risks of a big-bang refactor by ensuring we have tests and proper interfaces in place before moving code.

## User Review Required

> [!NOTE]
> This plan has been revised to focus on safety, testing, and incremental steps per your feedback. Let me know if you would like me to begin Phase 1 (Smoke Tests), or if we should focus on finishing any remaining v4.5 bugfixes first!

## Phase 1: Basic Smoke Tests
Before moving any code, we must establish a baseline of test coverage to ensure we don't break existing functionality during extraction.
- **[NEW] `tests/test_config.py`**: Test that [ConfigManager](file:///c:/Hobby/RDM/random_clip_player.py#135-207) successfully round-trips configurations (reading, writing, default values).
- **[NEW] `tests/test_session_client.py`**: Test that [SessionClient](file:///c:/Hobby/RDM/session_client.py#83-773) can initialize, connect, and disconnect properly.
- **[NEW] `tests/test_video_player.py`**: Test that [VideoPlayer](file:///c:/Hobby/RDM/random_clip_player.py#1806-3077) initializes without crashing and tear-down works.

## Phase 2: Constants & Interfaces Preparation
We need to untangle shared state and tightly coupled components before they can be moved into separate files.

### Shared State Isolation
- **[NEW] `rdm/constants.py`**: Move global/shared constants here so they aren't scattered across modules. Will include:
  - `COLORS` (used across all UI classes)
  - `VIDEO_EXTENSIONS` (used in VideoPlayer and upload logic)
  - `DEBUG_MODE`

### Interface Definitions
- **[MODIFY] `SessionPanel` & [VideoPlayer](file:///c:/Hobby/RDM/random_clip_player.py#1806-3077)**: `SessionPanel` currently holds a direct reference to [VideoPlayer](file:///c:/Hobby/RDM/random_clip_player.py#1806-3077) (`self._player`) and calls its private methods directly. 
  - We will define a proper signal-only contract (e.g., `PlayerSignals`) so `SessionPanel` communicates with [VideoPlayer](file:///c:/Hobby/RDM/random_clip_player.py#1806-3077) through Qt signals rather than direct method calls.

## Phase 3: Incremental Refactoring
Once tests are passing and interfaces are clean, we will extract one class at a time into the `rdm/` package. Each extraction will be verified against the smoke tests.

1. **[ConfigManager](file:///c:/Hobby/RDM/random_clip_player.py#135-207)** -> `rdm/config.py`
2. **[BlockedListDialog](file:///c:/Hobby/RDM/random_clip_player.py#208-295)** -> `rdm/ui/blocked_list_dialog.py`
3. **[SettingsDialog](file:///c:/Hobby/RDM/random_clip_player.py#356-560) & [KeybindButton](file:///c:/Hobby/RDM/random_clip_player.py#297-354)** -> `rdm/ui/settings_dialog.py`
4. **`SessionPanel`** -> `rdm/ui/session_panel.py` (after signal contract is established)
5. **UI Components**: Instead of a catch-all file, we'll extract them purposefully:
   - `rdm/ui/controls.py`: `DraggableWidget`, `DraggableButtonBar`
   - UI elements tightly coupled to [VideoPlayer](file:///c:/Hobby/RDM/random_clip_player.py#1806-3077) (like `SpeedButton` and `ClickableSlider`) may initially remain with it until a clearer separation point emerges.
6. **[SessionClient](file:///c:/Hobby/RDM/session_client.py#83-773)** -> `rdm/session_client.py` (ensuring `PyInstaller` hooks are updated)
7. **[VideoPlayer](file:///c:/Hobby/RDM/random_clip_player.py#1806-3077)** -> `rdm/app.py`
8. **Root Entry Point** -> `main.py`

## PyInstaller Build Updates
As we extract modules, we must update [RandomClipPlayer.spec](file:///c:/Hobby/RDM/RandomClipPlayer.spec) incrementally to ensure PyInstaller correctly bundles the new package structure.
- Update `hiddenimports` to explicitly include `rdm.*` submodules instead of the old `session_client` path.
- Keep the [random_clip_player.py](file:///c:/Hobby/RDM/random_clip_player.py) monolith functional for building until the new structure is fully verified.

---

## Copilot Review Notes

> **Status:** v4.5 shipped. This plan is approved for post-release execution with the caveats below.

### Strengths
- Phased approach with tests-first is correct and avoids the big-bang risk.
- `rdm/constants.py` for shared state solves cross-module dependency cleanly.
- Signal-only contract between `SessionPanel` and `VideoPlayer` is the right decoupling pattern.
- Keeping the monolith alive during migration provides a rollback path.
- Purposeful UI component splitting (not a catch-all) is pragmatic.

### Open Issues to Address Before Starting

1. **Circular import prevention.** Once `rdm/app.py` imports from `rdm/ui/session_panel.py` and `session_panel.py` needs types/signals defined near `VideoPlayer`, circular imports will occur. All shared types and the `PlayerSignals` class should live in `rdm/constants.py` or a dedicated `rdm/signals.py` to break cycles. This needs explicit planning before Phase 3 step 4.

2. **`setup_vlc()` placement.** This function runs at module level *before* `import vlc` and does PATH manipulation on Windows. It must be the very first thing that executes. It should go in `rdm/utils.py` and be called from `main.py` before any other `rdm` imports touch VLC. Document this ordering constraint.

3. **Phase 1 tooling.** `ConfigManager` is a pure unit test. But `VideoPlayer` init requires `QApplication` + VLC — use `pytest-qt` with a `qapp` fixture. `SessionClient` connect/disconnect needs either a mock server or `unittest.mock.patch` on `websocket.WebSocketApp`. Classify which tests are unit vs. integration upfront so expectations are clear.

4. **Phase 2 should be split.** Constants extraction (2a) is trivial and low-risk. The signal interface refactor (2b) is substantially harder — `SessionPanel` calls ~10 private methods on `VideoPlayer` via `self._player`. Converting these to signals requires defining signal signatures, wiring them in `VideoPlayer.__init__`, and verifying the async timing still works. These deserve separate commits.

5. **Phase 3 steps 7-8 are highest risk.** Extracting `VideoPlayer` into `rdm/app.py` is where all import chains converge. Flag this as a verification checkpoint — run smoke tests AND a PyInstaller build before and after.

### Future Technology Migration (post-refactor)

The refactor makes it feasible to later migrate the tech stack:
- **PyQt5 → PySide6**: Mostly mechanical (`from PyQt5` → `from PySide6`, enum style changes). PySide6 has proper type stubs, LGPL license, and active Qt6 development. PyQt5/Qt5 is effectively EOL.
- **python-vlc → mpv or Qt6 Multimedia**: VLC requires a system install, has no type stubs, and is a 40MB+ runtime dependency. `python-mpv` is a lighter drop-in; `PySide6 QMediaPlayer` eliminates external dependencies entirely. Either swap becomes straightforward once playback is isolated in `rdm/app.py`.
- **Execution order**: Refactor structure first (this plan), then PyQt5→PySide6, then VLC replacement. Never combine structural and technology migrations.
